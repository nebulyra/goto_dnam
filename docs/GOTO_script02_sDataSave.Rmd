---
title: "Script 2: Saving sData for MethylAid"
output:
  html_document:
    keep_md: false
    smart: false
    toc: true
    toc_float: true
    theme: united
date: 'Compiled: `r format(Sys.Date(), "%B %d, %Y")`'
---

```{r, setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/exports/molepi/users/ljsinke/GOTO/main/GOTO_Data/IDAT_files")
```

**This script uses MethylAid to perform sample-level quality control on the data from three studies: (i) GOTO, (ii) CD4+ T-cell functional experiments, and (iii) TwinLife.**

***

# Setup

Load packages

```{r message=FALSE, warning=FALSE}
library(MethylAid)
library(BiocParallel)
```

Load in the target files for each study

```{r}
load("../Processing/GOTO_targets-unfiltered.Rdata")
load("../../Study2_CD4T/CD4T_data-targets.Rdata")
load("../../Study3_TwinLife/TwinLife_data-targets.Rdata")
```

Set `BPPARAM`

```{r}
BPPARAM <- MulticoreParam(8)
```

***

# GOTO

One IDAT file was corrupted (`203527980080_R04C01`), so we removed it from targets. R.W. later sent an uncorrupted version, which we used to update the file.

Summarize IDAT files for MethylAid

```{r message=FALSE, warning=FALSE}
sData_goto <- summarize(targets_goto, 
                        batchSize=50, 
                        BPPARAM=BPPARAM,
                        force=TRUE)
```

Save sData

```{r}
save(sData_goto, file="../Processing/MethylAid/GOTO_sData-wave1.Rdata")
```

***

# CD4+ T-cell functional experiments

Summarize IDAT files for MethylAid

```{r message=FALSE, warning=FALSE}
sData_cd4t <- summarize(targets_cd4t, 
                        batchSize=50, 
                        force=TRUE)
```

Save

```{r}
save(sData_cd4t, file="../../Study2_CD4T/CD4T_data-sData.Rdata")
```

***

# TwinLife Pilot

Summarize IDAT files for MethylAid

```{r message=FALSE, warning=FALSE}
sData_twinlife <- summarize(targets_twinlife, 
                            batchSize=50, 
                            force=TRUE)
```

Save

```{r}
save(sData_twinlife, file="../../Study3_TwinLife/TwinLife_data-sData.Rdata")
```

***

Following saving of data, the `sData` objects were exported locally and inspected using MethylAid.

Outliers were saved in the study directory, for use in the next script. For GOTO, we identified 26 outliers and resent them in wave 2.

***

# Session Info

```{r}
sessionInfo()
```

Cleanup

```{r}
rm(list=ls())
```


